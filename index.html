<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GTK Lesson Plan Creator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .term-selection, .subject-input { display: none; }
    select[multiple] { height: 120px; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-6 px-4">
  <div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-indigo-800">GTK Adaptive Lesson Plan Creator</h1>
      <p class="text-lg text-gray-600 mt-2">Classes 1–12 • All Subjects • Tamil & English Medium</p>
    </div>

    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6 text-sm">
      <strong>Tip:</strong> Get your free Groq API key → <a href="https://console.groq.com/keys" target="_blank" class="text-blue-600 underline">console.groq.com/keys</a> → Paste below → Test Key
    </div>

    <form id="lessonPlanForm" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
      <!-- API Key + Test Button -->
      <div class="grid md:grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Your Groq API Key (gsk_...)</label>
          <input type="password" id="groqKey" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500" placeholder="Paste your key here" />
        </div>
        <div>
          <button type="button" id="testKeyBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition">
            Test Key
          </button>
        </div>
      </div>
      <div id="keyStatus" class="text-sm font-medium hidden"></div>

      <!-- Rest of the form (unchanged) -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Medium (மொழி)</label>
        <select id="medium" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          <option value="English">English Medium</option>
          <option value="Tamil">Tamil Medium</option>
        </select>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Class (வகுப்பு)</label>
          <select id="class" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="">-- Select Class --</option>
            <optgroup label="Primary (1–7)">…(same options)…</optgroup>
            <optgroup label="Secondary (8–10)">…</optgroup>
            <optgroup label="Higher Secondary">
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </optgroup>
          </select>
        </div>

        <div id="termDiv" class="term-selection">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Term</label>
          <div class="grid grid-cols-3 gap-3">
            <label class="flex items-center justify-center p-4 border-2 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
              <input type="radio" name="term" value="I" class="sr-only peer" required/>
              <span class="peer-checked:text-indigo-600 font-medium">Term I</span>
            </label>
            <label class="flex items-center justify-center p-4 border-2 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
              <input type="radio" name="term" value="II" class="sr-only peer" required/>
              <span class="peer-checked:text-indigo-600 font-medium">Term II</span>
            </label>
            <label class="flex items-center justify-center p-4 border-2 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
              <input type="radio" name="term" value="III" class="sr-only peer" required/>
              <span class="peer-checked:text-indigo-600 font-medium">Term III</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Subject (auto or manual) -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Subject (பாடம்)</label>
        <select id="subjectSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          <option value="">-- Select Subject --</option>
          <option value="Tamil">Tamil</option>
          <option value="English">English</option>
          <option value="Maths">Mathematics</option>
          <option value="Science">Science</option>
          <option value="Social">Social Science</option>
        </select>
        <input type="text" id="subjectInput" class="subject-input mt-3 w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Type subject (e.g. Physics, Chemistry)" />
      </div>

      <!-- Other fields (unchanged) -->
      <!-- ... Unit, Title, Dates, Nature, Methodology, Activity Focus, Sub-Activity ... -->

      <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold text-xl py-5 rounded-xl shadow-lg transition transform hover:scale-105">
        Generate Lesson Plan with AI
      </button>
      <div id="errorMsg" class="hidden bg-red-100 text-red-700 p-4 rounded-lg"></div>
    </form>

    <div id="lessonPlanOutput" class="hidden mt-12 bg-white rounded-2xl shadow-xl p-8">
      <h2 class="text-3xl font-bold text-indigo-800 text-center mb-8">Generated Lesson Plan</h2>
      <div id="lessonPlanContent" class="text-base leading-relaxed"></div>
      <div class="mt-10 text-center">
        <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-xl shadow-lg transition">
          Download as PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    let GROQ_API_KEY = '';

    // ==================== FIXED: Functions defined BEFORE they are used ====================
    function showStatus(msg, type = 'success') {
      const el = document.getElementById('keyStatus');
      el.textContent = msg;
      el.className = type === 'error' ? 'text-red-600' : 'text-green-600';
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 6000);
    }

    async function testKey() {
      const keyInput = document.getElementById('groqKey');
      const btn = document.getElementById('testKeyBtn');
      const status = document.getElementById('keyStatus');

      const key = keyInput.value.trim();
      if (!key) {
        showStatus('Please paste your Groq API key first!', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Testing…';
      showStatus('Testing key…', 'success');

      try {
        const res = await fetch('https://api.groq.com/openai/v1/models', {
          headers: { 'Authorization': `Bearer ${key}` }
        });

        if (res.ok) {
          const data = await res.json();
          console.log('Available models:', data.data.map(m => m.id));
          showStatus('Key OK! Ready to generate lesson plans', 'success');
        } else {
          const err = await res.json();
          showStatus(`Invalid key: ${err.error?.message || res.statusText}`, 'error');
        }
      } catch (e) {
        console.error(e);
        showStatus('Network error – check internet / try mobile data', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Test Key';
      }
    }

    // Attach click handler properly (works on mobile too)
    document.getElementById('testKeyBtn').addEventListener('click', testKey);

    // ==================== Rest of your original script (unchanged) ====================
    // (All activity options, getCurrentSubject, class change logic, getAIContent, generateHTML, downloadPDF, etc.)
    // ... Paste the entire script from the previous working version here ...

    // Example placeholder (replace with your full script):
    // include all functions: getCurrentSubject(), updateActivityOptions(), class change listener, getAIContent(), form submit, downloadPDF(), etc.

  </scriptt>
    <body>
      <!-- Medium -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Medium (மொழி)</label>
        <select id="medium" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200">
          <option value="English">English Medium</option>
          <option value="Tamil">Tamil Medium</option>
        </select>
      </div>

      <!-- Class + Term (for 1-7) -->
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Class (வகுப்பு)</label>
          <select id="class" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="">-- Select Class --</option>
            <optgroup label="Primary (1–7)">
              <option value="1">Class 1</option><option value="2">Class 2</option><option value="3">Class 3</option>
              <option value="4">Class 4</option><option value="5">Class 5</option><option value="6">Class 6</option><option value="7">Class 7</option>
            </optgroup>
            <optgroup label="Secondary (8–10)">
              <option value="8">Class 8</option><option value="9">Class 9</option><option value="10">Class 10</option>
            </optgroup>
            <optgroup label="Higher Secondary">
              <option value="11">Class 11</option><option value="12">Class 12</option>
            </optgroup>
          </select>
        </div>

        <!-- Term Selection (only for 1–7) -->
        <div id="termDiv" class="term-selection">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Term</label>
          <div class="grid grid-cols-3 gap-3">
            <label class="flex items-center justify-center p-4 border-2 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
              <input type="radio" name="term" value="I" class="sr-only peer" required/>
              <span class="peer-checked:text-indigo-600 font-medium">Term I</span>
            </label>
            <label class="flex items-center justify-center p-4 border-2 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
              <input type="radio" name="term" value="II" class="sr-only peer" required/>
              <span class="peer-checked:text-indigo-600 font-medium">Term II</span>
            </label>
            <label class="flex items-center justify-center p-4 border-2 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
              <input type="radio" name="term" value="III" class="sr-only peer" required/>
              <span class="peer-checked:text-indigo-600 font-medium">Term III</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Subject (auto or manual) -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Subject (பாடம்)</label>
        <select id="subjectSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          <option value="">-- Select Subject --</option>
          <option value="Tamil">Tamil</option>
          <option value="English">English</option>
          <option value="Maths">Mathematics</option>
          <option value="Science">Science</option>
          <option value="Social">Social Science</option>
        </select>
        <input type="text" id="subjectInput" class="subject-input mt-3 w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Type subject (e.g. Physics, Accountancy, Computer Science)" />
      </div>

      <!-- Rest of fields -->
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Unit / Chapter</label>
          <input type="text" id="unit" value="Unit 3" class="w-full px-4 py-3 border border-gray-300 rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Lesson Title</label>
          <input type="text" id="title" value="The Power of the Wind" class="w-full px-4 py-3 border border-gray-300 rounded-lg"/>
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Week Dates</label>
        <input type="text" id="dates" value="01/12/2025 - 05/12/2025" class="w-full px-4 py-3 border border-gray-300 rounded-lg"/>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Nature of the Lesson</label>
          <select id="nature" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="Stand alone">Stand alone</option>
            <option value="Building blocks">Building blocks</option>
            <option value="tree and branches">Tree and branches</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Methodology (hold to select multiple)</label>
          <select id="methodology" multiple class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="Interactive">Interactive</option>
            <option value="Explanatory">Explanatory</option>
            <option value="Demonstrative">Demonstrative</option>
            <option value="Do and learn">Do and learn</option>
            <option value="Playway">Playway</option>
          </select>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Activity Focus</label>
          <select id="activityFocus" required class="w-full px-4 py-3 border border-gray-300 rounded-lg"></select>
        </div>
        <div id="subActivityGroup" style="display:none;">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Sub-Activity Type</label>
          <select id="subActivity" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></select>
        </div>
      </div>

      <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold text-xl py-5 rounded-xl shadow-lg transition transform hover:scale-105">
        Generate Lesson Plan with AI
      </button>
      <div id="errorMsg" class="hidden bg-red-100 text-red-700 p-4 rounded-lg"></div>
    </form>

    <!-- Output -->
    <div id="lessonPlanOutput" class="hidden mt-12 bg-white rounded-2xl shadow-xl p-8 print:p-12 print:shadow-none">
      <h2 class="text-3xl font-bold text-indigo-800 text-center mb-8">Generated Lesson Plan</h2>
      <div id="lessonPlanContent" class="text-base leading-relaxed"></div>
      <div class="mt-10 text-center">
        <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-xl shadow-lg transition">
          Download as PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    let GROQ_API_KEY = '';

    // Activity options (unchanged)
    const activityOptions = {
        Language: [
            {value:"Motivation", label:"Motivation"},
            {value:"Listening/Speaking", label:"Listening/Speaking"},
            {value:"Reading", label:"Reading (Pre/While/Post)"},
            {value:"Writing", label:"Writing"},
            {value:"Grammar", label:"Grammar"}
        ],
        Core: [
            {value:"Motivation", label:"Motivation"},
            {value:"Consolidation", label:"Consolidation (Mind Map)"},
            {value:"Reinforcement", label:"Reinforcement"},
            {value:"Enrichment", label:"Enrichment"}
        ]
    };

    const consolidationOptions = [
        {value:"Events and facts", label:"Events and facts"},
        {value:"Timeline", label:"Timeline"},
        {value:"Pictures", label:"Pictures"},
        {value:"Tabular column", label:"Tabular column"},
        {value:"Hierarchial order", label:"Hierarchical order"},
        {value:"Concept map", label:"Concept map"},
        {value:"Fish bone", label:"Fish bone"},
        {value:"Sequencing", label:"Sequencing"}
    ];

    const langActivityOptions = {
        "Listening/Speaking": ["Brainstorm","Pair Work","Presentation"],
        "Reading": ["Pre-reading activities","While-reading activities","Post-reading activities"],
        "Writing": ["Hints, points, scaffolding","Group work","Presentation"],
        "Grammar": ["Explain the rules","Give examples","Invite more examples"]
    };

    function getSubjectCategory(s) {
        if (s === 'Tamil' || s === 'English') return 'Language';
        return 'Core';
    }

    // Updated to use current subject
    function updateActivityOptions() {
        const subject = getCurrentSubject();
        const select = document.getElementById('activityFocus');
        select.innerHTML = '<option value="">-- Select Activity Focus --</option>';
        document.getElementById('subActivityGroup').style.display = 'none';

        const cat = getSubjectCategory(subject);
        if (!cat) return;

        activityOptions[cat].forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.value; opt.textContent = o.label;
            select.appendChild(opt);
        });
    }

    function updateSubActivityOptions() {
        const focus = document.getElementById('activityFocus').value;
        const subGroup = document.getElementById('subActivityGroup');
        const subSelect = document.getElementById('subActivity');
        subSelect.innerHTML = '';
        subGroup.style.display = 'none';

        const subject = getCurrentSubject();
        const cat = getSubjectCategory(subject);

        let options = [];
        if (cat === 'Core' && focus === 'Consolidation') options = consolidationOptions;
        else if (cat === 'Language' && langActivityOptions[focus]) options = langActivityOptions[focus].map(v => ({value:v, label:v}));

        if (options.length > 0) {
            subGroup.style.display = 'block';
            options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.value; opt.textContent = o.label;
                subSelect.appendChild(opt);
            });
        }
    }

    // Helper to get current subject (select or input)
    function getCurrentSubject() {
      const cls = document.getElementById('class').value;
      if (cls === '11' || cls === '12') {
        return document.getElementById('subjectInput').value.trim() || 'Subject';
      }
      return document.getElementById('subjectSelect').value;
    }

    // Toggle Term & Subject Input
    document.getElementById('class').addEventListener('change', function() {
      const cls = this.value;
      const isPrimary = cls && parseInt(cls) <= 7;
      const isHigher = cls === '11' || cls === '12';

      document.getElementById('termDiv').classList.toggle('term-selection', !isPrimary); // Show for 1-7
      document.getElementById('subjectSelect').classList.toggle('hidden', isHigher);
      document.getElementById('subjectInput').classList.toggle('hidden', !isHigher);
      document.getElementById('subjectInput').classList.toggle('subject-input', isHigher);

      updateActivityOptions();
    });

    // Listen for subject changes
    document.getElementById('subjectSelect').addEventListener('change', updateActivityOptions);
    document.getElementById('subjectInput').addEventListener('input', updateActivityOptions);

    document.getElementById('activityFocus').addEventListener('change', updateSubActivityOptions);

    // NEW: Test Key Function
    async function testKey() {
        const keyInput = document.getElementById('groqKey');
        const status = document.getElementById('keyStatus');
        GROQ_API_KEY = keyInput.value.trim();
        if (!GROQ_API_KEY) {
            showStatus('Enter your key first!', 'error');
            return;
        }

        try {
            const res = await fetch('https://api.groq.com/openai/v1/models', {
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}` }
            });
            if (res.ok) {
                const data = await res.json();
                console.log('Available models:', data.data.map(m => m.id));  // Log to console
                showStatus('Key OK! Models available (check console).', 'success');
            } else {
                const err = await res.json();
                console.error('Test Error:', err);
                showStatus(`Error: ${err.error?.message || res.statusText} (Check console)`, 'error');
            }
        } catch (e) {
            console.error('Test Network Error:', e);
            showStatus('Network issue (firewall/VPN?). Try mobile data.', 'error');
        }
    }

    function showStatus(msg, type) {
        const el = document.getElementById('keyStatus');
        el.textContent = msg;
        el.className = type === 'error' ? 'text-red-600' : 'text-green-600';
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    // UPDATED AI FUNCTION with curriculum integration
    async function getAIContent(data, lang) {
        GROQ_API_KEY = document.getElementById('groqKey').value.trim();
        if (!GROQ_API_KEY) {
            showError('Paste your Groq API key.');
            return null;
        }

        // Enhanced prompt with curriculum focus
        const curriculumPrompt = `You are a Tamil Nadu State Board (Samacheer Kalvi) teacher. Generate content strictly based on the official TN State Board curriculum, syllabus, and textbooks available online from sources like tntextbooks.in, textbookcorp.in, dge.tn.gov.in, samacheerkalvi.guru. For Class \( {data.class} \){data.subject} \( {data.term ? 'Term ' + data.term : ''}, Unit \){data.unit}: "\( {data.title}". Ensure all content (outcomes, gist, aids, activities, homework, remedial) aligns precisely with the TN textbook content for this lesson. Do not invent; base on actual syllabus details. Output in \){lang}.

JSON only:
{
  "outcomes": "• Outcome 1\\n• Outcome 2\\n• Outcome 3 (from TN textbook objectives)",
  "gist": "6-8 line accurate summary from TN State Board textbook for this lesson.",
  "teachingAids": "Aids mentioned or suitable per TN curriculum (e.g., Blackboard, charts from textbook).",
  "activityDescription": "Detailed steps for \( {data.activityFocus} / \){data.subActivity}, aligned with Samacheer Kalvi methodology.",
  "weekEndActivity": "Homework directly from or inspired by TN textbook exercises.",
  "remedialAction": "Support strategies for slow learners as per TN guidelines."
}`;

        try {
            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.3-70b-versatile',  // FIXED: Current non-deprecated model (Nov 2025)
                    messages: [{ role: 'user', content: curriculumPrompt }],
                    temperature: 0.7,
                    max_tokens: 1200
                })
            });

            if (!res.ok) {
                const errData = await res.json();
                const msg = errData.error ? `\( {errData.error.type}: \){errData.error.message}` : `HTTP ${res.status}`;
                console.error('Groq Error:', msg, errData);
                showError(`API Error: ${msg}. Regenerate key?`);
                return null;
            }

            const json = await res.json();
            let text = json.choices[0].message.content;
            text = text.replace(/```json|```/g, '').trim();
            const parsed = JSON.parse(text);
            hideError();
            return parsed;

        } catch (e) {
            console.error('Fetch Error:', e);
            showError('Network error. Check console (F12).');
            return null;
        }
    }

    function showError(msg) {
        const el = document.getElementById('errorMsg');
        el.textContent = msg;
        el.classList.remove('hidden');
    }

    function hideError() {
        document.getElementById('errorMsg').classList.add('hidden');
    }

    // Form submission (updated with term and subject)
    document.getElementById('lessonPlanForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Generating with AI…';
        hideError();

        const data = {
            medium: document.getElementById('medium').value,
            class: document.getElementById('class').value,
            subject: getCurrentSubject(),
            term: document.querySelector('input[name="term"]:checked')?.value || '',
            unit: document.getElementById('unit').value,
            title: document.getElementById('title').value,
            dates: document.getElementById('dates').value,
            nature: document.getElementById('nature').value,
            methodology: Array.from(document.getElementById('methodology').selectedOptions).map(o=>o.value).join(', '),
            activityFocus: document.getElementById('activityFocus').value,
            subActivity: document.getElementById('subActivity').value || 'General',
            section: 'A',
            author: 'Tamil Nadu State Board'
        };

        const lang = (data.medium === 'English' && data.subject === 'Tamil') ? 'Tamil' : data.medium;

        const ai = await getAIContent(data, lang);

        // Fallback (updated to be more curriculum-aligned)
        if (!ai) {
            data.outcomes = '• Students will understand key concepts from 
              data.gist = `Gist of "\( {data.title}": Based on TN textbook content for Class \){data.class} ${data.subject} - Core concepts, examples, and applications as per Samacheer Kalvi syllabus.`;
            data.teachingAids = 'Blackboard, textbook illustrations, charts from TN curriculum.';
            data.activityDescription = `For \( {data.activityFocus} ( \){data.subActivity}): Follow TN textbook activities - Read, discuss, create summary aligned with syllabus.`;
            data.weekEndActivity = 'Complete textbook exercises for this unit at home.';
            data.remedialAction = 'Extra practice from textbook; peer support as per TN guidelines.';
        } else {
            data.outcomes = ai.outcomes;
            data.gist = ai.gist;
            data.teachingAids = ai.teachingAids;
            data.activityDescription = ai.activityDescription;
            data.weekEndActivity = ai.weekEndActivity;
            data.remedialAction = ai.remedialAction;
        }

        document.getElementById('lessonPlanContent').innerHTML = generateHTML(data, lang);
        document.getElementById('lessonPlanOutput').style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Generate Lesson Plan with AI';
        window.scrollTo({ top: document.getElementById('lessonPlanOutput').offsetTop, behavior: 'smooth' });
    });

    function generateHTML(d, lang) {
        return `
            <h3 style="color:#0066cc;">\( {d.unit}: \){d.title}</h3>
            <table class="w-full border-collapse mb-6" style="border:1px solid #ccc;">
                <tr><td style="border:1px solid #ccc;padding:10px;width:30%;"><b>1. Subject, Class, Section, Dates</b></td>
                    <td style="border:1px solid #ccc;padding:10px;">\( {d.subject}, \){d.class} \( {d.term ? '| Term ' + d.term : ''}, \){d.section}, ${d.dates}</td></tr>
                <tr><td style="border:1px solid #ccc;padding:10px;"><b>2. Unit, Title, Author</b></td>
                    <td style="border:1px solid #ccc;padding:10px;">\( {d.unit}, \){d.title}, ${d.author}</td></tr>
                <tr><td style="border:1px solid #ccc;padding:10px;"><b>3. Nature of Lesson</b></td>
                    <td style="border:1px solid #ccc;padding:10px;">${d.nature}</td></tr>
                <tr><td style="border:1px solid #ccc;padding:10px;"><b>4. Learning Outcomes</b></td>
                    <td style="border:1px solid #ccc;padding:10px;">${d.outcomes.replace(/\n/g,'<br>')}</td></tr>
                <tr><td style="border:1px solid #ccc;padding:10px;"><b>5. Methodology</b></td>
                    <td style="border:1px solid #ccc;padding:10px;">${d.methodology}</td></tr>
                <tr><td style="border:1px solid #ccc;padding:10px;"><b>6. Teaching Aids</b></td>
                    <td style="border:1px solid #ccc;padding:10px;">${d.teachingAids}</td></tr>
            </table>

            <h4>7. Gist of the Lesson (from TN State Board Textbook)</h4>
            <p>${d.gist}</p>

            <h4>8. Activities Planned</h4>
            <p><b>Focus:</b> ${d.activityFocus}<br>
               <b>Type:</b> ${d.subActivity}</p>
            <p><b>Description:</b><br>${d.activityDescription.replace(/\n/g,'<br>')}</p>

            <h4>9. Week-end Activity</h4>
            <p>${d.weekEndActivity}</p>

            <h4>10. Remedial Action</h4>
            <p>${d.remedialAction}</p>

            <p class="text-right italic mt-8">
                <b>Medium of Instruction:</b> ${lang} | <b>Curriculum:</b> Samacheer Kalvi (TN State Board)
            </p>
        `;
                                                                      }
     // Fixed PDF Download (multi-page, mobile-friendly)
    async function downloadPDF() {
      const content = document.getElementById('lessonPlanContent');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');

      const canvas = await html2canvas(content, { 
        scale: 2, 
        useCORS: true,
        width: content.scrollWidth,
        height: content.scrollHeight
      });
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 190;
      const pageHeight = 290;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;

      let position = 10;
      pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft >= 0) {
        position = heightLeft - imgHeight + 10; // Adjust for overlap
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      const title = document.getElementById('title').value.replace(/[^a-zA-Z0-9]/g, '_');
      pdf.save(`${title}_LessonPlan.pdf`);
    }

    // Load on start
    updateActivityOptions();
  </script>
</body>
</html>
