<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TNSB Lesson Plan Generator</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.9.0/dist/transformers.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
.hidden { display: none !important; }
</style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4">

<div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold text-center text-indigo-800 mb-1">Tamil Nadu State Board</h1>
    <h2 class="text-2xl text-center text-indigo-700 mb-6">Lesson Plan Generator (OCR + AI)</h2>

    <div id="statusBox" class="hidden bg-indigo-100 border border-indigo-400 text-indigo-800 p-4 rounded-lg text-center mb-6">
        Processing...
    </div>

    <div class="bg-white rounded-2xl shadow-2xl p-8 space-y-8">

        <div>
            <label class="block font-bold mb-2 text-lg">Upload Textbook PDF</label>
            <input type="file" id="pdfFile" accept="application/pdf" class="w-full px-4 py-3 border-2 rounded-lg bg-white" />
        </div>

        <div id="pageInputs" class="hidden grid grid-cols-2 gap-6">
            <div>
                <label class="block font-bold mb-2">From Page</label>
                <input type="number" id="fromPage" class="w-full px-4 py-3 border-2 rounded-lg" />
            </div>
            <div>
                <label class="block font-bold mb-2">To Page</label>
                <input type="number" id="toPage" class="w-full px-4 py-3 border-2 rounded-lg" />
            </div>
        </div>

        <button id="runOCR"
            class="hidden w-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-xl py-4 rounded-xl shadow-lg">
            OCR Selected Pages & Auto-Fill Form
        </button>

        <div id="formSection" class="hidden space-y-8">

            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <label class="block font-bold mb-2">Subject</label>
                    <input id="subjectInput" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="English" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Class</label>
                    <input id="cls" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="10" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Section</label>
                    <input id="sectionInput" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="A" />
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <label class="block font-bold mb-2">Unit</label>
                    <input id="unitInput" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="Unit 3" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Lesson Title</label>
                    <input id="lessonTitle" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="Heat" />
                </div>
                <div>
                    <label class="block font-bold mb-2">Author</label>
                    <input id="lessonAuthor" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="Author" />
                </div>
            </div>

            <div>
                <label class="block font-bold mb-2">Week / Dates</label>
                <input id="dates" value="02/12/2025 - 06/12/2025"
                    class="w-full px-4 py-3 border-2 rounded-lg" />
            </div>

            <button id="generatePlan"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-4 rounded-xl shadow-lg">
                Generate Lesson Plan (AI)
            </button>

        </div>
    </div>

    <div id="result" class="hidden mt-12 bg-white rounded-2xl shadow-2xl p-10 border-4 border-indigo-200">
        <h2 class="text-3xl font-bold text-center text-indigo-800 mb-6">Lesson Plan</h2>
        <div id="content" class="text-lg leading-relaxed"></div>

        <div class="text-center mt-12">
            <button onclick="downloadPDF()"
                class="bg-red-600 hover:bg-red-700 text-white font-bold text-xl py-4 px-16 rounded-xl shadow-lg">
                Download PDF
            </button>
        </div>
    </div>

</div>


<script>
let summarizer = null;
let ocrText = "";

// ELEMENT SHORTCUTS
const statusBox = document.getElementById("statusBox");
const pageInputs = document.getElementById("pageInputs");
const runOCR = document.getElementById("runOCR");
const formSection = document.getElementById("formSection");
const content = document.getElementById("content");
const result = document.getElementById("result");

// AUTO-FILL DEFAULT VALUES
document.getElementById("subjectInput").value = "English";
document.getElementById("cls").value = "10";
document.getElementById("sectionInput").value = "A";
document.getElementById("unitInput").value = "Unit 3";
document.getElementById("lessonTitle").value = "Heat";
document.getElementById("lessonAuthor").value = "Textbook Author";

// DATE AUTO-FILL TODAYS WEEK
document.getElementById("dates").value =
    new Date().toLocaleDateString() + " - " +
    new Date(Date.now() + 4 * 86400000).toLocaleDateString();


//--------------------------------------------
// AI MODEL LOADER
//--------------------------------------------
async function loadModel() {
    if (!summarizer) {
        setStatus("Loading AI model…");
        summarizer = await window.transformers.pipeline("summarization", "Xenova/t5-small");
        setStatus("");
    }
}

//--------------------------------------------
// STATUS DISPLAY + THINKING COUNTDOWN
//--------------------------------------------
let countdownInterval = null;

function setStatus(msg, seconds = 0) {
    clearInterval(countdownInterval);

    if (!msg) {
        statusBox.classList.add("hidden");
        return;
    }

    statusBox.classList.remove("hidden");
    statusBox.textContent = msg;

    if (seconds > 0) {
        let remaining = seconds;
        statusBox.textContent = `${msg} (${remaining}s)`;

        countdownInterval = setInterval(() => {
            remaining--;
            statusBox.textContent = `${msg} (${remaining}s)`;

            if (remaining <= 0) clearInterval(countdownInterval);
        }, 1000);
    }
}


//--------------------------------------------
// PDF SELECTED → SHOW PAGE INPUTS
//--------------------------------------------
document.getElementById("pdfFile").addEventListener("change", () => {
    pageInputs.classList.remove("hidden");
    runOCR.classList.remove("hidden");
});


//--------------------------------------------
// OCR PROCESS
//--------------------------------------------
async function ocrSelectedPages(file, start, end) {
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    let text = "";

    for (let p = start; p <= end; p++) {
        setStatus("Reading page " + p + " …", 3);
        const page = await pdf.getPage(p);
        const vp = page.getViewport({ scale: 1.6 });

        const canvas = document.createElement("canvas");
        canvas.width = vp.width;
        canvas.height = vp.height;

        await page.render({ canvasContext: canvas.getContext("2d"), viewport: vp }).promise;
        const result = await Tesseract.recognize(canvas, "tam+eng");
        text += result.data.text + " ";
    }

    setStatus("");
    return text;
}


//--------------------------------------------
// OCR BUTTON
//--------------------------------------------
runOCR.addEventListener("click", async () => {
    let file = pdfFile.files[0];
    let fp = parseInt(fromPage.value);
    let tp = parseInt(toPage.value);

    if (!file || !fp || !tp) return alert("Please enter pages!");

    setStatus("Extracting text using OCR…", 12);
    ocrText = await ocrSelectedPages(file, fp, tp);

    formSection.classList.remove("hidden");
    formSection.scrollIntoView({ behavior: "smooth" });
});


//--------------------------------------------
// LESSON PLAN GENERATOR
//--------------------------------------------
async function buildLessonPlanAI() {
    await loadModel();

    setStatus("Thinking… Summarizing lesson", 10);

    const summary = await summarizer(ocrText || "This is placeholder text.", {
        max_length: 120,
        min_length: 50
    });

    let gist = summary[0].summary_text || "Lesson summary unavailable.";

    setStatus("Preparing Lesson Plan…", 5);

    return `
<h3 class='font-bold text-indigo-700 text-xl'>1. Subject, Class, Section, Dates</h3>
<b>Subject:</b> ${subjectInput.value}<br>
<b>Class:</b> ${cls.value}<br>
<b>Section:</b> ${sectionInput.value}<br>
<b>Dates:</b> ${dates.value}<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>2. Unit, Title, Author</h3>
<b>Unit:</b> ${unitInput.value}<br>
<b>Title:</b> ${lessonTitle.value}<br>
<b>Author:</b> ${lessonAuthor.value}<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>3. Nature & Format</h3>
Stand-alone / Building-Block Lesson.<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>4. Learning Outcomes</h3>
Students will understand, explain and apply the core concepts of the lesson.<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>5. Methodology</h3>
Interactive teaching, demonstration, questioning, peer activity.<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>6. Teaching Aids</h3>
Textbook, board, charts, ICT tools.<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>7. Gist of the Lesson</h3>
${gist}<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>8. Activities</h3>
Listening, Speaking, Pair-Work, Brainstorming, Writing Tasks.<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>9. Weekend Activity</h3>
Students complete a short report or activity based on the lesson.<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>10. Remedial Action</h3>
Provide practice worksheets and simpler explanations for slow learners.<br><br>
`;
}


//--------------------------------------------
// GENERATE BUTTON CLICK
//--------------------------------------------
document.getElementById("generatePlan").addEventListener("click", async () => {

    setStatus("Thinking… Preparing Final Output", 8);

    const output = await buildLessonPlanAI();

    content.innerHTML = output;
    result.classList.remove("hidden");

    result.scrollIntoView({ behavior: "smooth" });

    setStatus("");
});


//--------------------------------------------
// PDF DOWNLOAD
//--------------------------------------------
async function downloadPDF() {
    const element = document.getElementById("content");
    const canvas = await html2canvas(element, { scale: 2 });
    const img = canvas.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    const width = pdf.internal.pageSize.getWidth() - 20;
    const height = (canvas.height * width) / canvas.width;

    pdf.addImage(img, "PNG", 10, 10, width, height);
    pdf.save("LessonPlan.pdf");
}
</script>
</body>
</html>
