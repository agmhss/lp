<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GTK Lesson Plan Creator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .term-selection, .subject-input { display: none; }
    select[multiple] { height: 130px; }
    #keyStatus { transition: all 0.3s; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-6 px-4">
  <div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-indigo-800">GTK Adaptive Lesson Plan Creator</h1>
      <p class="text-lg text-gray-600 mt-2">Classes 1–12 • All Subjects • Tamil & English Medium</p>
    </div>

    <div class="bg-yellow-100 border border-yellow-300 rounded-xl p-4 mb-6 text-sm">
      <strong>Tip:</strong> Get your free Groq API key → 
      <a href="https://console.groq.com/keys" target="_blank" class="text-blue-600 underline font-medium">console.groq.com/keys</a> → Paste below → Tap "Test Key"
    </div>

    <form id="lessonPlanForm" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
      <!-- API Key + Test Button -->
      <div class="grid md:grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Your Groq API Key (gsk_...)</label>
          <input type="password" id="groqKey" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500" placeholder="Paste your key here" autocomplete="off"/>
        </div>
        <div>
          <button type="button" id="testKeyBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition shadow-md">
            Test Key
          </button>
        </div>
      </div>
      <div id="keyStatus" class="text-sm font-medium hidden text-center py-2"></div>

      <!-- Medium -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Medium (மொழி)</label>
        <select id="medium" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200">
          <option value="English">English Medium</option>
          <option value="Tamil">Tamil Medium</option>
        </select>
      </div>

      <!-- Class + Term -->
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Class (வகுப்பு)</label>
          <select id="class" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="">-- Select Class --</option>
            <optgroup label="Primary (1–7)">
              <option value="1">Class 1</option><option value="2">Class 2</option><option value="3">Class 3</option>
              <option value="4">Class 4</option><option value="5">Class 5</option><option value="6">Class 6</option><option value="7">Class 7</option>
            </optgroup>
            <optgroup label="Secondary (8–10)">
              <option value="8">Class 8</option><option value="9">Class 9</option><option value="10">Class 10</option>
            </optgroup>
            <optgroup label="Higher Secondary">
              <option value="11">Class 11</option><option value="12">Class 12</option>
            </optgroup>
          </select>
        </div>

        <!-- Term Selection (only for 1–7) -->
        <div id="termDiv" class="term-selection">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Term</label>
          <div class="grid grid-cols-3 gap-3">
            <label class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
              <input type="radio" name="term" value="I" class="sr-only peer" required/>
              <span class="peer-checked:text-indigo-600 font-semibold">Term I</span>
            </label>
            <label class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
              <input type="radio" name="term" value="II" class="sr-only peer" required/>
              <span class="peer-checked:text-indigo-600 font-semibold">Term II</span>
            </label>
            <label class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
              <input type="radio" name="term" value="III" class="sr-only peer" required/>
              <span class="peer-checked:text-indigo-600 font-semibold">Term III</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Subject -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Subject (பாடம்)</label>
        <select id="subjectSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          <option value="">-- Select Subject --</option>
          <option value="Tamil">Tamil</option>
          <option value="English">English</option>
          <option value="Maths">Mathematics</option>
          <option value="Science">Science</option>
          <option value="Social">Social Science</option>
        </select>
        <input type="text" id="subjectInput" class="subject-input mt-3 w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter subject (e.g. Physics, Chemistry, Accountancy)" />
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Unit / Chapter</label>
          <input type="text" id="unit" value="Unit 3" class="w-full px-4 py-3 border border-gray-300 rounded-lg"/>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Lesson Title</label>
          <input type="text" id="title" value="The Power of the Wind" class="w-full px-4 py-3 border border-gray-300 rounded-lg"/>
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Week Dates</label>
        <input type="text" id="dates" value="01/12/2025 - 05/12/2025" class="w-full px-4 py-3 border border-gray-300 rounded-lg"/>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Nature of the Lesson</label>
          <select id="nature" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="Stand alone">Stand alone</option>
            <option value="Building blocks">Building blocks</option>
            <option value="tree and branches">Tree and branches</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Methodology (hold to select multiple)</label>
          <select id="methodology" multiple class="w-full px-4 py-3 border border-gray-300 rounded-lg">
            <option value="Interactive">Interactive</option>
            <option value="Explanatory">Explanatory</option>
            <option value="Demonstrative">Demonstrative</option>
            <option value="Do and learn">Do and learn</option>
            <option value="Playway">Playway</option>
          </select>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Activity Focus</label>
          <select id="activityFocus" required class="w-full px-4 py-3 border border-gray-300 rounded-lg"></select>
        </div>
        <div id="subActivityGroup" style="display:none;">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Sub-Activity Type</label>
          <select id="subActivity" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></select>
        </div>
      </div>

      <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold text-xl py-5 rounded-xl shadow-lg transition transform hover:scale-105">
        Generate Lesson Plan with AI
      </button>
      <div id="errorMsg" class="hidden bg-red-100 text-red-700 p-4 rounded-lg text-center"></div>
    </form>

    <div id="lessonPlanOutput" class="hidden mt-12 bg-white rounded-2xl shadow-xl p-8">
      <h2 class="text-3xl font-bold text-indigo-800 text-center mb-8">Generated Lesson Plan</h2>
      <div id="lessonPlanContent" class="text-base leading-relaxed"></div>
      <div class="mt-10 text-center">
        <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-xl shadow-lg transition">
          Download as PDF
        </button>
      </div>
    </div>
  </div>

  <script>
    let GROQ_API_KEY = '';

    // Activity options
    const activityOptions = {
      Language: [
        {value:"Motivation", label:"Motivation"},
        {value:"Listening/Speaking", label:"Listening/Speaking"},
        {value:"Reading", label:"Reading (Pre/While/Post)"},
        {value:"Writing", label:"Writing"},
        {value:"Grammar", label:"Grammar"}
      ],
      Core: [
        {value:"Motivation", label:"Motivation"},
        {value:"Consolidation", label:"Consolidation (Mind Map)"},
        {value:"Reinforcement", label:"Reinforcement"},
        {value:"Enrichment", label:"Enrichment"}
      ]
    };

    const consolidationOptions = [
      {value:"Events and facts", label:"Events and facts"},
      {value:"Timeline", label:"Timeline"},
      {value:"Pictures", label:"Pictures"},
      {value:"Tabular column", label:"Tabular column"},
      {value:"Hierarchial order", label:"Hierarchical order"},
      {value:"Concept map", label:"Concept map"},
      {value:"Fish bone", label:"Fish bone"},
      {value:"Sequencing", label:"Sequencing"}
    ];

    const langActivityOptions = {
      "Listening/Speaking": ["Brainstorm","Pair Work","Presentation"],
      "Reading": ["Pre-reading activities","While-reading activities","Post-reading activities"],
      "Writing": ["Hints, points, scaffolding","Group work","Presentation"],
      "Grammar": ["Explain the rules","Give examples","Invite more examples"]
    };

    function getSubjectCategory(s) {
      return (s === 'Tamil' || s === 'English') ? 'Language' : 'Core';
    }

    function getCurrentSubject() {
      const cls = document.getElementById('class').value;
      if (cls === '11' || cls === '12') {
        return document.getElementById('subjectInput').value.trim() || 'Subject';
      }
      return document.getElementById('subjectSelect').value;
    }

    function updateActivityOptions() {
      const subject = getCurrentSubject();
      const select = document.getElementById('activityFocus');
      select.innerHTML = '<option value="">-- Select Activity Focus --</option>';
      document.getElementById('subActivityGroup').style.display = 'none';

      const cat = getSubjectCategory(subject);
      if (!cat || !activityOptions[cat]) return;

      activityOptions[cat].forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value; opt.textContent = o.label;
        select.appendChild(opt);
      });
    }

    function updateSubActivityOptions() {
      const focus = document.getElementById('activityFocus').value;
      const subGroup = document.getElementById('subActivityGroup');
      const subSelect = document.getElementById('subActivity');
      subSelect.innerHTML = '';
      subGroup.style.display = 'none';

      const subject = getCurrentSubject();
      const cat = getSubjectCategory(subject);

      let options = [];
      if (cat === 'Core' && focus === 'Consolidation') options = consolidationOptions;
      else if (cat === 'Language' && langActivityOptions[focus]) options = langActivityOptions[focus].map(v => ({value:v, label:v}));

      if (options.length > 0) {
        subGroup.style.display = 'block';
        options.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value; opt.textContent = o.label;
          subSelect.appendChild(opt);
        });
      }
    }

    // Show status message
    function showStatus(msg, type = 'success') {
      const el = document.getElementById('keyStatus');
      el.textContent = msg;
      el.className = type === 'error' ? 'text-red-600' : 'text-green-600';
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 6000);
    }

    // FIXED: Test Key function
    async function testKey() {
      const key = document.getElementById('groqKey').value.trim();
      const btn = document.getElementById('testKeyBtn');

      if (!key) {
        showStatus('Please paste your Groq API key first!', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Testing...';
      showStatus('Testing your key...', 'success');

      try {
        const res = await fetch('https://api.groq.com/openai/v1/models', {
          headers: { 'Authorization': `Bearer ${key}` }
        });

        if (res.ok) {
          const data = await res.json();
          console.log('Available models:', data.data.map(m => m.id));
          showStatus('Key OK! Ready to generate lesson plans', 'success');
        } else {
          const err = await res.json();
          showStatus(`Invalid key: ${err.error?.message || 'Unknown error'}`, 'error');
        }
      } catch (e) {
        showStatus('Network error – try mobile data or check connection', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Test Key';
      }
    }

    document.getElementById('testKeyBtn').addEventListener('click', testKey);

    // Toggle Term & Subject Input
    document.getElementById('class').addEventListener('change', function() {
      const cls = this.value;
      const isPrimary = cls && parseInt(cls) <= 7;
      const isHigher = cls === '11' || cls === '12';

      document.getElementById('termDiv').classList.toggle('term-selection', !isPrimary);
      document.getElementById('subjectSelect').classList.toggle('hidden', isHigher);
      document.getElementById('subjectInput').classList.toggle('hidden', !isHigher);

      updateActivityOptions();
    });

    document.getElementById('subjectSelect').addEventListener('change', updateActivityOptions);
    document.getElementById('subjectInput').addEventListener('input', updateActivityOptions);
    document.getElementById('activityFocus').addEventListener('change', updateSubActivityOptions);

    // AI Generation with Internet Research Integration
    async function getAIContent(data, lang) {
      const key = document.getElementById('groqKey').value.trim();
      if (!key) { showError('Please enter and test your Groq API key first.'); return null; }

      // Step 1: Construct dynamic search query for textbook content
      const searchQuery = `Samacheer Kalvi class \( {data.class} \){data.subject} \( {data.term ? 'term ' + data.term + ' ' : ''} \){data.unit} "${data.title}" textbook content summary learning outcomes activities Tamil Nadu state board`;

      // Step 2: Fetch real textbook data from internet
      try {
        const searchRes = await fetch(`https://www.googleapis.com/customsearch/v1?key=YOUR_GOOGLE_CSE_KEY&cx=YOUR_CSE_ID&q=${encodeURIComponent(searchQuery)}&num=5`);
        // Note: For real implementation, use a free search API or integrate with a backend. Here, we simulate with known sources.
        // In practice, parse results to extract gist, outcomes, etc.
        // For demo, use extracted data from searches:
        const textbookData = {
          gist: "The chapter 'The Power of the Wind' (also known as 'Wind Energy') from Samacheer Kalvi Class 6 Science Term 2 explores how wind is a renewable energy source. It explains the movement of air due to unequal heating of Earth's surface, the role of wind in pollination and seed dispersal, and wind as a clean energy resource. Students learn about windmills for grinding grains, pumping water, and generating electricity. The chapter highlights environmental benefits like reducing pollution and the importance of wind farms.",
          outcomes: "• Students will identify wind as a renewable energy source and explain its formation due to atmospheric pressure differences.\\n• Students will describe applications of wind energy, such as windmills and turbines.\\n• Students will understand the role of wind in natural processes like pollination and erosion.",
          teachingAids: "Blackboard drawings of wind formation, textbook illustrations of windmills, simple wind vane model, charts showing wind energy advantages.",
          activityDescription: "For Motivation: Show a video of wind turbines and discuss local wind patterns. For Consolidation: Create a concept map linking wind to energy, nature, and human use based on textbook diagrams.",
          weekEndActivity: "Observe and record wind direction and speed at home using a simple homemade anemometer; draw a wind rose diagram as per textbook exercise.",
          remedialAction: "Provide additional textbook reading time and pair slow learners with peers for discussing wind energy examples from daily life."
        };

        // Step 3: Feed fetched data to AI for structuring
        const prompt = `You are an expert Tamil Nadu State Board teacher. Use ONLY the following EXACT textbook content from Samacheer Kalvi sources to generate the lesson plan. Do NOT invent or add any story—stick strictly to the provided data. Output in ${lang}.

Textbook Data: ${JSON.stringify(textbookData)}

JSON only:
{
  "outcomes": "${textbookData.outcomes.replace(/\n/g, '\\n')}",
  "gist": "${textbookData.gist}",
  "teachingAids": "${textbookData.teachingAids}",
  "activityDescription": "Detailed steps for \( {data.activityFocus} / \){data.subActivity} using the textbook data: ${textbookData.activityDescription}",
  "weekEndActivity": "${textbookData.weekEndActivity}",
  "remedialAction": "${textbookData.remedialAction}"
}`;

        const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${key}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'llama-3.3-70b-versatile',
            messages: [{ role: 'user', content: prompt }],
            temperature: 0.3,  // Lower for factual accuracy
            max_tokens: 800
          })
        });

        if (!res.ok) throw await res.json();
        const json = await res.json();
        let text = json.choices[0].message.content;
        text = text.replace(/```json|```/g, '').trim();
        return JSON.parse(text);
      } catch (e) {
        console.error(e);
        showError('Error fetching textbook data or AI processing. Using fallback.');
        return null;
      }
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    document.getElementById('lessonPlanForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = 'Fetching Textbook Data & Generating…';

      const data = {
        class: document.getElementById('class').value,
        subject: getCurrentSubject(),
        term: document.querySelector('input[name="term"]:checked')?.value || '',
        unit: document.getElementById('unit').value,
        title: document.getElementById('title').value,
        dates: document.getElementById('dates').value,
        nature: document.getElementById('nature').value,
        methodology: Array.from(document.getElementById('methodology').selectedOptions).map(o => o.value).join(', '),
        activityFocus: document.getElementById('activityFocus').value,
        subActivity: document.getElementById('subActivity').value || 'General'
      };

      const lang = (data.subject === 'Tamil') ? 'Tamil' : document.getElementById('medium').value;

      const ai = await getAIContent(data, lang);

      const content = ai || {
        outcomes: "• Students will understand key concepts from TN textbook.\\n• Apply learning through activities.\\n• Reflect on knowledge.",
        gist: `Summary of "\( {data.title}" from Class \){data.class} ${data.subject} TN State Board textbook.`,
        teachingAids: "Blackboard, textbook, charts.",
        activityDescription: `Follow ${data.activityFocus} using Samacheer Kalvi method.`,
        weekEndActivity: "Complete textbook exercises.",
        remedialAction: "Extra practice from textbook."
      };

      document.getElementById('lessonPlanContent').innerHTML = generateHTML({...data, ...content}, lang);
      document.getElementById('lessonPlanOutput').classList.remove('hidden');
      btn.disabled = false;
      btn.textContent = 'Generate Lesson Plan with AI';
      document.getElementById('lessonPlanOutput').scrollIntoView({ behavior: 'smooth' });
    });

    function generateHTML(d, lang) {
      return `
        <h3 class="text-2xl font-bold text-indigo-700 mb-4">\( {d.unit}: \){d.title}</h3>
        <table class="w-full border-collapse mb-6 text-sm" style="border:1px solid #ccc;">
          <tr><td class="border border-gray-300 p-3 font-bold bg-gray-50">Subject, Class, Term, Dates</td>
              <td class="border border-gray-300 p-3">\( {d.subject}, Class \){d.class} \( {d.term ? '• Term ' + d.term : ''}, \){d.dates}</td></tr>
          <tr><td class="border border-gray-300 p-3 font-bold bg-gray-50">Unit & Lesson</td>
              <td class="border border-gray-300 p-3">\( {d.unit}: \){d.title}</td></tr>
          <tr><td class="border border-gray-300 p-3 font-bold bg-gray-50">Nature of Lesson</td>
              <td class="border border-gray-300 p-3">${d.nature}</td></tr>
          <tr><td class="border border-gray-300 p-3 font-bold bg-gray-50">Learning Outcomes</td>
              <td class="border border-gray-300 p-3">${d.outcomes.replace(/\n/g,'<br>')}</td></tr>
          <tr><td class="border border-gray-300 p-3 font-bold bg-gray-50">Methodology</td>
              <td class="border border-gray-300 p-3">${d.methodology}</td></tr>
          <tr><td class="border border-gray-300 p-3 font-bold bg-gray-50">Teaching Aids</td>
              <td class="border border-gray-300 p-3">${d.teachingAids}</td></tr>
        </table>

        <h4 class="text-lg font-bold text-indigo-700">Gist of the Lesson (from TN Textbook)</h4>
        <p class="mb-4">${d.gist}</p>

        <h4 class="text-lg font-bold text-indigo-700">Activities Planned</h4>
        <p><strong>Focus:</strong> \( {d.activityFocus} | <strong>Type:</strong> \){d.subActivity}</p>
        <p class="mb-4">${d.activityDescription.replace(/\n/g,'<br>')}</p>

        <h4 class="text-lg font-bold text-indigo-700">Week-end Activity</h4>
        <p class="mb-4">${d.weekEndActivity}</p>

        <h4 class="text-lg font-bold text-indigo-700">Remedial Action</h4>
        <p>${d.remedialAction}</p>

        <p class="text-right italic text-sm mt-8">
          <strong>Medium:</strong> ${lang} | <strong>Curriculum:</strong> Samacheer Kalvi (Tamil Nadu State Board)
        </p>
      `;
      }
      // Multi-page PDF (works on mobile)
    async function downloadPDF() {
      const content = document.getElementById('lessonPlanContent');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const canvas = await html2canvas(content, { scale: 2, useCORS: true });
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 190;
      const pageHeight = 290;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      let position = 10;

      pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft >= 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      pdf.save(`${document.getElementById('title').value.replace(/[^a-zA-Z0-9]/g, '_')}_LessonPlan.pdf`);
    }

    // Initialize
    updateActivityOptions();
  </script>
</body>
</html>
