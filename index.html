<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TNSB Lesson Plan Generator – AI + OCR</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- Transformers.js -->
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.9.0/dist/transformers.min.js"></script>

<style>
.hidden { display:none !important; }
</style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4">
<div class="max-w-4xl mx-auto">

<h1 class="text-4xl font-bold text-center text-indigo-800 mb-1">Tamil Nadu State Board</h1>
<h2 class="text-2xl text-center text-indigo-700 mb-6">Lesson Plan Generator (OCR + AI)</h2>

<div id="statusBox" class="hidden bg-indigo-100 border border-indigo-400 text-indigo-800 p-4 rounded-lg text-center mb-6">
  Processing...
</div>

<div class="bg-white rounded-2xl shadow-2xl p-8 space-y-8">

    <div>
        <label class="block font-bold mb-2 text-lg">Upload Textbook PDF</label>
        <input type="file" id="pdfFile" accept="application/pdf"
            class="w-full px-4 py-3 border-2 rounded-lg bg-white" />
    </div>

    <div id="pageInputs" class="hidden grid grid-cols-2 gap-6">
        <div>
            <label class="block font-bold mb-2">From Page</label>
            <input type="number" id="fromPage" class="w-full px-4 py-3 border-2 rounded-lg" />
        </div>
        <div>
            <label class="block font-bold mb-2">To Page</label>
            <input type="number" id="toPage" class="w-full px-4 py-3 border-2 rounded-lg" />
        </div>
    </div>

    <button id="runOCR" class="hidden w-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-xl py-4 rounded-xl shadow-lg">
        OCR Selected Pages & Auto-Fill Form
    </button>

    <div id="formSection" class="hidden space-y-8">

        <div class="grid md:grid-cols-3 gap-6">
            <div>
                <label class="block font-bold mb-2">Subject</label>
                <input id="subjectInput" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="English" />
            </div>
            <div>
                <label class="block font-bold mb-2">Class</label>
                <input id="cls" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="10" />
            </div>
            <div>
                <label class="block font-bold mb-2">Section</label>
                <input id="sectionInput" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="A" />
            </div>
        </div>

        <div class="grid md:grid-cols-3 gap-6">
            <div>
                <label class="block font-bold mb-2">Unit</label>
                <input id="unitInput" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="Unit 3" />
            </div>
            <div>
                <label class="block font-bold mb-2">Lesson Title</label>
                <input id="lessonTitle" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="Heat" />
            </div>
            <div>
                <label class="block font-bold mb-2">Author</label>
                <input id="lessonAuthor" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="Author" />
            </div>
        </div>

        <div>
            <label class="block font-bold mb-2">Week / Dates</label>
            <input id="dates" value="02/12/2025 - 06/12/2025" class="w-full px-4 py-3 border-2 rounded-lg" />
        </div>

        <button id="generatePlan" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-4 rounded-xl shadow-lg">
            Generate Lesson Plan (AI)
        </button>
    </div>

</div>

<div id="result" class="hidden mt-12 bg-white rounded-2xl shadow-2xl p-10 border-4 border-indigo-200">
  <h2 class="text-3xl font-bold text-center text-indigo-800 mb-6">Lesson Plan</h2>
  <div id="content" class="text-lg leading-relaxed"></div>

  <div class="text-center mt-12">
    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold text-xl py-4 px-16 rounded-xl shadow-lg">
        Download PDF
    </button>
  </div>
</div>

</div>

<script>
let summarizer = null;

async function loadModel() {
    if (!summarizer) {
        summarizer = await window.transformers.pipeline(
            "summarization",
            "Xenova/t5-small"
        );
    }
}

function setStatus(msg){
    const box = document.getElementById("statusBox");
    if (!msg) box.classList.add("hidden");
    else { box.classList.remove("hidden"); box.textContent = msg; }
}

document.getElementById("pdfFile").addEventListener("change", () => {
    pageInputs.classList.remove("hidden");
    runOCR.classList.remove("hidden");
});

async function ocrSelectedPages(file, start, end) {
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    let text = "";

    for (let p = start; p <= end; p++) {
        setStatus("Reading Page " + p + " ...");

        const page = await pdf.getPage(p);
        const vp = page.getViewport({ scale: 1.6 });
        const canvas = document.createElement("canvas");
        canvas.width = vp.width;
        canvas.height = vp.height;

        await page.render({ canvasContext: canvas.getContext("2d"), viewport: vp }).promise;
        const result = await Tesseract.recognize(canvas, "tam+eng");
        text += result.data.text + " ";
    }

    setStatus("");
    return text;
}

runOCR.addEventListener("click", async () => {
    const file = pdfFile.files[0];
    const fp = parseInt(fromPage.value);
    const tp = parseInt(toPage.value);

    if (!file || !fp || !tp) {
        alert("Please upload PDF & enter page numbers");
        return;
    }

    const rawText = await ocrSelectedPages(file, fp, tp);
    window.ocrText = rawText;

    formSection.classList.remove("hidden");
    formSection.scrollIntoView({ behavior: "smooth" });
});

async function buildLessonPlanAI() {

    await loadModel();

    setStatus("AI is summarizing the lesson...");

    const summary = await summarizer(window.ocrText, {
        max_length: 120,
        min_length: 40
    });

    const gist = summary[0].summary_text;

    setStatus("AI generating lesson plan...");

    const aiPlanText = `
Generate a detailed 10‑point school lesson plan based on this text:

TEXT: ${window.ocrText}

Use this structure:
1. Subject, Class, Section, Dates
2. Unit, Title, Author
3. Nature of the lesson & Format
4. Learning Outcomes
5. Methodology
6. Teaching Aids
7. Gist of the Lesson (use summary)
8. Activities (Listening/Speaking/Reading/Writing)
9. Weekend Activity
10. Remedial Action
`;

    const plan = await summarizer(aiPlanText, {
        max_length: 250,
        min_length: 150
    });

    setStatus("");

    return `
<h3 class='font-bold text-indigo-700 text-xl'>1. Subject, Class, Section, Dates</h3>
<b>Subject:</b> ${subjectInput.value}<br>
<b>Class:</b> ${cls.value}<br>
<b>Section:</b> ${sectionInput.value}<br>
<b>Dates:</b> ${dates.value}<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>2. Unit, Title, Author</h3>
<b>Unit:</b> ${unitInput.value}<br>
<b>Title:</b> ${lessonTitle.value}<br>
<b>Author:</b> ${lessonAuthor.value}<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>3. Nature & Format</h3>
Automatically determined by AI.<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>4. Learning Outcomes</h3>
${plan[0].summary_text}<br><br>

<h3 class='font-bold text-indigo-700 text-xl'>7. Gist of the Lesson</h3>
${gist}<br><br>
`;
}

document.getElementById("generatePlan").addEventListener("click", async () => {
    const output = await buildLessonPlanAI();
    content.innerHTML = output;
    result.classList.remove("hidden");
    result.scrollIntoView({ behavior: "smooth" });
});

async function downloadPDF() {
    const btn = document.getElementById('pdfDownloadBtn');
    const element = document.getElementById('lessonPlanContent');
    
    // Temporarily show button again if needed (optional)
    btn.disabled = true;
    btn.textContent = 'Generating PDF...';

    try {
        // Force full render: scroll to top and allow reflow
        window.scrollTo(0, 0);
        await new Promise(resolve => setTimeout(resolve, 100));

        const scale = window.devicePixelRatio >= 2 ? 2 : 2; // Good quality even on retina
        const canvas = await html2canvas(element, {
            scale: scale,
            useCORS: true,                  // Important if you have external images/fonts
            allowTaint: false,
            backgroundColor: '#ffffff',
            scrollY: -window.scrollY,       // Critical for full capture
            scrollX: 0,
            windowWidth: document.documentElement.offsetWidth,
            height: element.scrollHeight,   // Force full height
            width: element.scrollWidth,
            logging: false                  // Set true only for debugging
        });

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        const margin = 10; // mm
        const usableWidth = pageWidth - 2 * margin;
        const usableHeight = pageHeight - 2 * margin;

        const imgWidth = canvas.width;
        const imgHeight = canvas.height;

        // Calculate ratio to fit width (we scale proportionally)
        const ratio = usableWidth / imgWidth;
        let heightInMM = imgHeight * ratio;

        let position = 0;
#lessonPlanContent {
    background: white;
    overflow-x: hidden; /* Prevents horizontal scroll during capture */
}

#lessonPlanContent table {
    break-inside: avoid;
    page-break-inside: avoid;
}
        // Add first page
        pdf.addImage(imgData, 'PNG', margin, margin, usableWidth, heightInMM);

        // Add additional pages if content is longer than one A4 page
        while (heightInMM >= usableHeight) {
            pdf.addPage();
            position -= pageHeight; // Move up by one full page
            pdf.addImage(imgData, 'PNG', margin, position + margin, usableWidth, imgHeight * ratio);
            heightInMM -= usableHeight;
        }

        // Generate safe filename
        const title = (document.getElementById('title')?.value || 'Lesson_Plan')
            .trim()
            .replace(/[^a-zA-Z0-9\-_ ]/g, '')
            .replace(/\s+/g, '_');

        pdf.save(`${title}_LessonPlan.pdf`);

    } catch (error) {
        console.error("PDF generation failed:", error);
        alert("Failed to generate PDF. Please try again.");
    } finally {
        btn.disabled = false;
        btn.textContent = 'Download PDF'; // or whatever your original text was
    }
}

</script>
</body>
</html>
